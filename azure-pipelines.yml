# ASP.NET
# Build and test ASP.NET projects.
# Add steps that publish symbols, save build artifacts, deploy, and more:
# https://docs.microsoft.com/azure/devops/pipelines/apps/aspnet/build-aspnet-4

trigger:
- main

variables:
  solution: '**/*.sln'
  buildPlatform: 'Any CPU'
  buildConfiguration: 'Release'
  
stages:
- stage: build
  jobs:

  - job: NotifyStart
    pool: server

    steps:
    - task: InvokeRESTAPI@1
      inputs:
        connectionType: 'connectedServiceName'
        serviceConnection: 'Build Light'
        method: 'POST'
        headers: |
          {
            "Content-Type":"application/json",
            "Authorization":"Bearer $(LifxToken)"
          }
        body: |
          {
            "color": "#ff9900",
            "from_color": "#ffaa00",
            "period": 4,
            "cycles": 100,
            "persist": false,
            "power_on": true
          }
        urlSuffix: 'effects/breathe'
        waitForCompletion: 'true'
  
  - job: BuildJob
    pool:
      vmImage: 'windows-latest'

    steps:
    - task: NuGetToolInstaller@1

    - task: NuGetCommand@2
      inputs:
        restoreSolution: '$(solution)'

    - task: UseNode@1
      inputs:
        versionSpec: '10.x'
        
    - task: VSBuild@1
      inputs:
        solution: '$(solution)'
        msbuildArgs: '/p:DeployOnBuild=true /p:WebPublishMethod=Package /p:PackageAsSingleFile=true /p:SkipInvalidConfigurations=true /p:PackageLocation="$(build.artifactStagingDirectory)"'
        platform: '$(buildPlatform)'
        configuration: '$(buildConfiguration)'

    - task: VSTest@2
      inputs:
        platform: '$(buildPlatform)'
        configuration: '$(buildConfiguration)'

    - task: CopyFiles@2
      inputs:
        SourceFolder: 'Deploy'
        TargetFolder: '$(Build.ArtifactStagingDirectory)'

    - task: PublishBuildArtifacts@1
      inputs:
        PathtoPublish: '$(Build.ArtifactStagingDirectory)'
        ArtifactName: 'drop'
        publishLocation: 'Container'

  - job: PostBuild
    dependsOn: BuildJob
    pool: server

    steps:
    - task: InvokeRESTAPI@1
      inputs:
        connectionType: 'connectedServiceName'
        serviceConnection: 'Build Light'
        method: 'PUT'
        headers: |
          {
            "Content-Type":"application/json",
            "Authorization":"Bearer $(LifxToken)"
          }
        body: |
          {
            "power": "on",
            "color": "#00ff00"
          }
        urlSuffix: 'state'
        waitForCompletion: 'true'